#! /usr/bin/env nix-shell
#! nix-shell -i bash -p nix git --pure

# Build a tarball with Miking and the necessary dependencies.
# Usage:
#
#     $ /path/to/miking-pack
#
# To run this script, you need only Nix.  See README.md for more
# information.

set -e

export packdir="$(mktemp -d /tmp/miking-pack.XXXXXX)"

custom_deps=('miking')

ocaml_deps=('ocaml' 'findlib' 'dune_3' 'owl' 'lwt' 'toml')

nixpkgs_deps=('binutils-unwrapped' 'gcc.cc')

static_deps=('patchelf' 'gnugrep' 'file')

install_dep() {
    echo "Copying from $1 to $packdir."
    cp -an $1/* $packdir
    # Files copied from the nix store are unwritable, so update the permissions.
    chmod -R +w $packdir
}

install_transitive_deps() {
    nix-store --query --requisites "$1" | while read dep_path; do
        install_dep "$dep_path"
    done
}

install_miking() {
    echo "Installing Miking and dependencies to $packdir."
    for dep in "${custom_deps[@]}"; do
        install_transitive_deps \
            "$(nix-build "$(dirname "${BASH_SOURCE[0]}")" -A $dep --no-out-link)"
    done
    for dep in "${ocaml_deps[@]}"; do
        install_transitive_deps \
            "$(nix-build '<nixpkgs>' -A ocaml-ng.ocamlPackages_5_0.$dep --no-out-link)"
    done
    for dep in "${nixpkgs_deps[@]}"; do
        install_transitive_deps "$(nix-build '<nixpkgs>' -A $dep --no-out-link)"
    done
    for dep in "${static_deps[@]}"; do
        install_dep "$(nix-build '<nixpkgs>' -A pkgsStatic.$dep --no-out-link)"
    done
}

patch_binaries() {
    echo "Patching dynamic library paths in binaries."
    find $packdir/bin $packdir/libexec $packdir/lib -type f \
         ! -name '*.a' ! -name '*.cma' ! -name '*.cmi' ! -name '*.cmti' ! -name '*.cmx' \
         ! -name '*.h' ! -name '*.la' ! -name '*.ml' ! -name '*.mli' ! -name '*.o' \
         -exec bash -c 'file {} | grep -e "ELF.*\(executable\|shared\).*dynamic"' \; \
         -exec bash -c 'patchelf --set-rpath "\$ORIGIN/$(realpath --relative-to="$(dirname {})" $packdir/lib)" {}' \;
    sed -i -e 's,/nix/store/[^/]*/lib/,,g' $packdir/lib/libc.so $packdir/lib/libm.so
    mv $packdir/bin/.mi-wrapped $packdir/bin/mi
    ln -s gcc $packdir/bin/cc
}

prepare_scripts() {
    echo "Preparing setup and wrapper scripts."
    cat <<'EOS' > $packdir/mi-setup
#!/bin/sh
echo "Setting up bundled Miking for use."
export SOURCE="$(dirname "$(realpath "$0")")"
echo "Bundle directory:  $SOURCE"
export MAGIC="$SOURCE/share/misc/magic.mgc"
find $SOURCE/bin $SOURCE/libexec -type f \
     -exec /bin/sh -c '$SOURCE/bin/file {} | $SOURCE/bin/grep -qe "ELF.*executable.*dynamic"' \; \
     -exec $SOURCE/bin/patchelf \
     --set-interpreter $SOURCE/lib/ld-linux-x86-64.so.2 {} \;
echo "Finished setup."
EOS
    cat <<'EOS' > $packdir/mi
#!/bin/sh
SOURCE="$(dirname "$(realpath "$0")")"
export OCAMLPATH="$SOURCE/lib/ocaml:$SOURCE/lib/ocaml/5.0.0/site-lib"
export OCAMLLIB="$SOURCE/lib/ocaml"
export PATH="$SOURCE/bin"
export LIBRARY_PATH="$SOURCE/lib"
export MCORE_LIBS="stdlib=$SOURCE/lib/mcore/stdlib"
export OCAMLPARAM=":_:ccopt=-Wl,--dynamic-linker=$SOURCE/lib/ld-linux-x86-64.so.2,-rpath=$SOURCE/lib"
unset  OPAM_SWITCH_PREFIX
unset  LD_LIBRARY_PATH
exec -a "$0" "$SOURCE/bin/mi" "$@"
EOS
    chmod +x $packdir/mi $packdir/mi-setup
}

make_tarball() {
    install_miking
    patch_binaries
    prepare_scripts
    tar -C "$(dirname $packdir)" -czvf miking-pack.tar.gz "$(basename $packdir)"
    rm -rf $packdir
}

make_tarball
